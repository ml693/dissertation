% Template for a Computer Science Tripos Part II project dissertation
\documentclass[12pt,a4paper,oneside,openright]{report}

\usepackage{amsmath, amsthm, amssymb}
\usepackage{array}
\usepackage{color}
\usepackage{docmute}   % only needed to allow inclusion of proposal.tex
\usepackage[margin=15mm]{geometry}  % adjusts page layout
\usepackage{graphicx}  % allows inclusion of PDF, PNG and JPG images
\usepackage[pdfborder={0 0 0}]{hyperref}    % turns references into hyperlinks
\usepackage{pdfpages}
\usepackage{verbatim}
\usepackage[bottom]{footmisc}

\newcolumntype{C}{>{{}}c<{{}}}

\setlength{\parindent}{0ex}

\clubpenalty1000%
\raggedbottom                           % try to avoid widows and orphans
\renewcommand{\baselinestretch}{1.1}    % adjust line spacing to make readable
\sloppy
\widowpenalty1000%

\begin{document}
\bibliographystyle{plain}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Title

{\let\cleardoublepage}

\rightline{\LARGE \textbf{Marius Latinis}}

\vspace*{60mm}
\begin{center}
\Huge
\textbf{Bus Arrival Time Prediction} \\[5mm]
Computer Science Tripos -- Part II \\[5mm]
Christ's College \\[5mm]
\today  % today's date
\end{center}
\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Proforma, table of contents and list of figures

\pagestyle{empty}

\chapter*{Proforma}

{\large
\begin{tabular}{ll}
\textcolor{blue}{Name}: & \bf Marius Latinis                        \\
\textcolor{blue}{College}:            & \bf Christ's College                     \\
\textcolor{blue}{Project Title}:      & \bf Bus Arrival Time Prediction \\
\textcolor{blue}{Examination}:        & \bf Computer Science Tripos -- Part II, July 2017  \\
\textcolor{blue}{Word Count}:         & \bf \textcolor{red}{TODO(ml693): figure out} \\
\textcolor{blue}{Project Originator}: & \bf Dr Richard Mortier \\
\textcolor{blue}{Supervisor}:         & \bf Dr Richard Mortier \\ 
\end{tabular}
}
\stepcounter{footnote}


\section*{Original Aims of the Project}

\begin{itemize}
\item Implement the prediction algorithm. The GPS points showing how the bus has moved
so far are given as an input. The output of the prediction algorithm is the predicted
time when this bus will arrive at the future stop.

\item Evaluate the prediction algorithm and present the results.

\end{itemize}

\section*{Work Completed}

The following milestones have been achieved:

\begin{itemize}
\item The prediction algorithm is implemented.
\item The algorithm is evaluated and the results are presented in the evaluation section.
\item (Optional) the real-time prediction system is running.
\end{itemize}

\section*{Special Difficulties}

None
 
\section*{Declaration}

I, Marius Latinis of Christ's College, being a candidate for Part II of the Computer
Science Tripos, hereby declare that this dissertation and the work described 
in it are my own work, unaided except as may be specified below,
and that the dissertation does not contain material that has already been used to any substantial extent for a comparable purpose.

\bigskip
\leftline{Signed [signature]}

\medskip
\leftline{Date \today}

\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% now for the chapters

\pagestyle{plain}


\chapter{Introduction}

\section{Motivation}

In the European countries, public buses are a popular form of transportation. However,
buses often arrive later than the timetable announces. Therefore, the project aims
to build an algorithm which accurately predicts the bus arrival times based on the
most recent GPS data.

\section{Overview of the Actual Problem}

\includegraphics[width=\textwidth]{figs/problem_overview.png} \\

The most recent GPS points (indicated in green in the diagram above) show
where the bus has travelled up to now. The future data (indicated in red)
is not known during the prediction phase. My goal is to predict the future
data given the present data. \\

In this specific example I want to predict when the bus will reach the Madingley Park 
starting from the Chesterton Road. One can see it takes about 8 min. (10:59--11:07)
to travel such distance.

\chapter{Preparation}

\section{Starting Point}

\section*{Initial Starting Data}
A company named Vix is sending the real-time GPS data to the Cambridge servers. The GPS
data shows how certain\footnote{\textcolor{red}{TODO(ml693): buses from which
companies?}} East-England buses are moving in the real-time. The Cambridge servers
convert the binary GPS data into a human readable JSON format. I was given the JSON data
spanning 3 months (June, July and August 2016). That was the starting point data. \\

I started coding this part completely from scratch.

\section*{Starting Data for the Real-time System}
In the second term, I started building the real-time system as an optional extension.
The optional part requires the real-time GPS data. To start with, Dr. Lewis gave me
the access to the machine receiving the new GPS data from the Vix company every 30sec. \\

The code receiving the real-time GPS data was already written. I started this
part by writing the new code processing the received GPS data.

\section{Preliminary Work}

The arrival time prediction problem can be approached in multiple ways. A clever approach
allows making progress quickly and with ease. On the other hand, a wrong
choice\footnote{For example, I believe that building a complicated algorithm without
trying a simple solution first is a wrong choice.} forces a programmer spend many hours
trying to debug the code and understand why it does not handle the data as expected. I
did a thourough preparation to choose a correct approach. \\

\newpage

Firstly, I read two papers describing how other scientists are solving this problem:

\begin{enumerate}

\item Pengfei Zhou, Yuanqing Zheng, Mo Li: How Long to Wait? Predicting Bus Arrival Time with Mobile Phone based Participatory Sensing

\textcolor{blue}{\url{http://www.ntu.edu.sg/home/limo/papers/sys012fp.pdf}}

\item Bin Yu, William H.K. Lam, Mei Lam Tam: Bus arrival time prediction at
bus stop with multiple routes 

\textcolor{blue}{\url{http://www.sciencedirect.com/science/article/pii/S0968090X11000155}}

\end{enumerate}

I learned the common evaluation metrics used by reading these papers. I also looked at
the results claimed in those papers to get a first clue how well the current prediction
systems are working. \\

Secondly, I talked to multiple people in Cambridge. Several lecturers gave me good tips.
For example, my overseers pointed out that knowing the exact streets a bus follows is
not neccesary for making a prediction. Only the GPS points where the bus has moved so far
and the geographic location of the future bus stop can be enough to predict the arrival
time to that stop. This advice saved a lot of my time as I did not have to search
for a good map data. \\

Finally, after talking with Prof Kelly I became convinced that building a simple algorithm
described in this dissertation is the right way to start solving the arrival time
prediction problem.\footnote{Other lecturers were advising me to use the more
sophisticated techniques, such as Machine Learning or Multivariate Analysis.
I decided to discard these techniques in favour of a simpler solution.}

\chapter{Implementation}

\section{Data Preprocessing}

Below is the starting point input data example: \\
\includegraphics[width=\textwidth]{figs/starting_data.png} \\

One file contains a single snapshot of all buses, 
with one entry per bus. An entry such as:

\includegraphics[width=\textwidth]{figs/entry.png} \\

means that a vehicle nr. $132$ was at the geographical position
$(51.891663, -0.45255125)$ on the $2$nd August $2016$, GMT time
$01$:$51$:$05$\footnote{The time is calculated from the timestamp field.}. \\

A new snapshot file arrives once in $30$s. The data preprocessing part
takes multiple input files\footnote{For example, to build historical trips, I take all
files received in \textbf{one} day.} and converts them into another format: \\

\includegraphics[width=\textwidth]{figs/converted_format.jpg} \\

At the end I have a file for each trip made by one bus in one
day\footnote{Note that a bus on a particurlar day could have made
multiple trips.}. \\

Visually the data preprocessing part converts the following set of GPS points

\includegraphics[width=\textwidth]{figs/unprocessed.png} \\

into a separated list of trips, 2 of which are shown below:

\includegraphics[width=\textwidth]{figs/processed.png} \\

An optional use\footnote{The main use is that the preprocessing part is one of the
components of the whole arrival time prediction system.} of the preprocessing part
is the help it provides to visually inspect the data. I am able to look at each trip
separately (or to merge multiple trips of my choice) and understand why the buses are
moving in such a way.

\section{Route Detection Algorithm}

\subsection{Why an Algorithm is Needed}

\includegraphics[scale=0.8]{figs/route_detector.png} \\

The GPS points indicated in green show how the bus has moved so far.
The red points show where the bus will travel in the future,
a path I do not know yet. Predicting when the bus will arrive at the stop
requires knowing \textbf{where} a bus will travel next. How? \\

\textbf{Approach Using Static Data} \\

A standard way to find out where the bus will travel next is to know its 
route in advance. Some GPS entries contain additional fields,
such as the \textbf{label} field: \\

\includegraphics[width=\textwidth, scale=1.2]{figs/labelled_entry.png} \\

An extra field \textbf{label} names the route a bus follows. Auxiliary
data might indicate what route the label \textbf{ATS-3603} corresponds to.
One can then look at the route and determine a sequence of stops 
a bus will visit next. \\

Unfortunately, this approach has drawbacks:

\begin{itemize}
\item Not all entries contain auxiliary fields. After all, the GPS device on the
actual vehicle is responsible only for providing the latitude and longitude
coordinates, not the route a bus follows.

\item Good static data to infer routes based on additional fields is not 
straightforward to find. Field values might not match
(For example, a route named \textbf{SW-4} in the real-time data is actually
\textbf{SWX-4}).
Buses are often changing routes\footnote{A bus is unlikely to follow the same route
every day} and data does not always indicate that.

\item The static data only shows the sequence of bus stops, not a detailed
sequence of streets a bus will follow. It is much better to know an actual
path for the accurate arrival time prediction.
\end{itemize}

\textbf{New Approach Overview} \\

To overcome the static data limitations, I propose a new way to infer the
route a bus follows. I will align a sub-trip how the bus has moved
so far with a historical path for which the route is known. The path aligning
best to the current sub-trip will be used to predict where a bus travels next.
To perform the alignment, I constructed an algorithm\footnote{From now on referred
to as a boolean predicate.} that can tell whether one sequence of GPS points 
follows another.

\subsection{$FollowsPath$ Predicate Definition}

I define a predicate $FollowsPath(sub$-$trip, path)$ to be true iff a $sub$-$trip$
follows a $path$: \\

\includegraphics[width=\textwidth, scale=1.2]{figs/follows_path.jpg} \\

Two pictures show when I want the predicate to return true and when false.
For the first example, the predicate returns true because it is intuitively
clear that a red sub-trip follows a blue path. In the second example, the
output is false, as the two GPS sequences do not intersect at all.

\newpage

\subsection{$FollowsPath$ Predicate Implementation}

Firstly, consider the case when a \textcolor{red}{sub- trip's} GPS points
$(\textcolor{red}{P_0}, \textcolor{red}{P_1}, ..., \textcolor{red}{P_{n-1}})$
\textbf{exactly} follow another \textcolor{blue}{path}: \\

\includegraphics[width=\textwidth]{figs/follows_exactly.jpg}

Each point $P_i$ is on some segment of another trip's path.
For example, $P_1$ is on the segment $AB$.
Let $x = |AP_1|$ and $y = |P_1B|$. Then the
error\footnote{error function takes a point and a segment as an input} function
defined as \\

\begin{centering}
$err(P_1, AB) = \frac{x + y}{|AB|} - 1$ \\
\end{centering}

\:
\:
\:

equals $0$. For each point $P_i$, I find a segment $S_{P_i}$ such that
$err(P_i, S_{P_i})$ is minimised. The $FollowsPath$ predicate returns true
iff

\begin{centering}
    $S = \sum_{i=0}^{n-1} err(P_i, S_{P_i}) < n\epsilon$ \\
\end{centering}

\:
\:
\:

for a suitably chosen threshold value $\epsilon$\footnote{$\epsilon = 0.1$
is one choice}. \\

Note that $S = 0$ when a \textcolor{red}{sub-trip} follows a
\textcolor{blue}{path} exactly. Therefore, in this case, the $FollowsPath$
predicate returns true, which is what I want. \\

The case when a \textcolor{red}{sub-trip} does follow a
\textcolor{blue}{path}, but not exactly (the real world situation), 
is illustrated in the following picture: \\

\includegraphics[width=\textwidth]{figs/follows_roughly.png}

In this example I am aligning a \textcolor{red}{sub-trip}
$(\textcolor{red}{R_0}, ..., \textcolor{red}{R_9})$ with a \textcolor{blue}{path}
$(\textcolor{cyan}{B_0}, ..., \textcolor{cyan}{B_7}, ...)$.
The computation of $S$ proceeds as follows:
\[
\setlength\arraycolsep{0pt}
\begin{array}{ *{7}{cC} c }
 S &=& err(\textcolor{red}{R_0}, \textcolor{cyan}{{B_0}{B_1}}) &+& 
       err(\textcolor{red}{R_1}, \textcolor{cyan}{{B_0}{B_1}}) &+& 
       err(\textcolor{red}{R_2}, \textcolor{cyan}{{B_2}{B_3}}) &+& 
       err(\textcolor{red}{R_3}, \textcolor{cyan}{{B_2}{B_3}}) &+& 
       err(\textcolor{red}{R_4}, \textcolor{cyan}{{B_2}{B_3}}) &+  \\
   & & err(\textcolor{red}{R_5}, \textcolor{cyan}{{B_3}{B_4}}) &+& 
       err(\textcolor{red}{R_6}, \textcolor{cyan}{{B_4}{B_5}}) &+& 
       err(\textcolor{red}{R_7}, \textcolor{cyan}{{B_5}{B_6}}) &+& 
       err(\textcolor{red}{R_8}, \textcolor{cyan}{{B_6}{B_7}}) &+&
       err(\textcolor{red}{R_9}, \textcolor{cyan}{{B_6}{B_7}}) &   \\
   &=& (1.0294 - 1)  &+& (1.0300 - 1) &+& (1.0021 - 1)  &+& (1.0730 - 1)  &+& 
       (1.0208 - 1)   &+  \\ 
   & & (1.0714 - 1)  &+& (1.0286 - 1)  &+& (1.0158 - 1)  &+&  (1.0126 - 1)  &+& 
       (1.0125 - 1)   &<& 10 \cdot 0.1 =& n\epsilon
\end{array}
\]

and the predicate again returns true, as desired. \\

Finally, when a sub-trip does not follow a path,
triangle inequality will ensure large values of
$err(P_i, S_{P_i})$\footnote{$err(P_i, S_{P_i}) = \frac{x_i + y_i}{|S_{P_i}|} - 1
\gg (1 + \epsilon) - 1 = \epsilon \implies S \gg n\epsilon$},
thus the sum $S$ will exceed $n\epsilon$, and the predicate will return false. \\

The practical evidence that $FollowsPath$ predicate works is shown in the 
evaluation section.

\newpage

\section{Arrival Time Prediction}

\subsection{Basic Idea}

The $FollowsPath$ predicate allows to detect the route a bus follows.
The route tells the next stops a bus will visit. This section shows how to
predict the arrival time to each future bus stop. \\

Historical trips (which follow the same route) are used to make a prediction:

\includegraphics[width=\textwidth]{figs/future_stop.png} \\

In the picture above 2 example historical sub-trips (\textcolor{blue}{blue}
and \textcolor{red}{red}) are shown.
Both of them start where the vehicle currently located is (indicated
using the most recent green point). Both of them represent the history how past
vehicles travelled until the bus stop. I compute the duration how long it
took for each historical trip to reach the bus stop. Knowing multiple duration
values I return the median as the predicted arrival time.

\subsection{Optimisation Nr. 1}

If in the historical trips set certain trips have \textbf{just} travelled along
the same route (e.g. in the last $30$min.), I predict the median time just from
those recent trips. Otherwise, the basic approach is used.

\subsection{Optimisation Nr. 2}

Suppose the most recent data

\includegraphics[scale = 0.7]{figs/recent_trip.png} \\

shows the distance a bus has travelled in the last $16$ minutes. Certain historical
trips

\includegraphics[scale = 0.7]{figs/inaccurate_historical.png} \\

have travelled the same distance in a very different amount of 
time\footnote{This could have happened due different traffic congestion level
in a different time of the day.} (e.g. $4$ min.). Predicting arrival time using
these historical trips can be misleading. Hence I filter out such trips.
I.E. I take only those historical trips into account that have travelled the same
distance in roughly the same amount of time\footnote{Up to 30sec. difference
is allowed.}. \\

Optimisations are tested in the evaluation section.


\newpage

\section{Real-time System (Optional)}

I am processing the GPS data at real time. The goal of this chapter is to present
the current system's state so that whoever comes after
me\footnote{Such as another student next year.} can understand the system and
improve it. \\

One machine every 30s. accepts a new JSON file containing the GPS data. For each new
file the machine does the following:

\begin{enumerate}

\item[(a)] Reads the new GPS data from the file and updates the arrival time
prediction values.

Below is a flow chart handling
\textbf{one} bus:

\includegraphics[scale = 0.6]{figs/flowchart.png} \\

This is how for \textbf{each} bus I \textbf{independently} process its new GPS data
and predict the arrival time to the next bus stops. Currently one machine is
waiting for $t$ sec., then using the new GPS data to handle $50$ buses in 
$30 - t$ sec.\footnote{Of course, I am trying to minimise $t$.}

\item[(b)] Saves the JSON file to a disc. Once in 24h reads the files saved on a disc
and generates the new historical data to improve the future predictions.

The current state of a system is such that for each new day I save the JSON files
to a separate directory. When a day $d+1$ comes, I read all JSON files from day $d$
and perform the data preprocessing part (3.1) on those files. This generates
about $20000$ trips for each day. For each of the trip generated I then detect
which route it followed and save this trip into the historical trips directory
corresponding to that route. Hence, after each day I generate new historical trips
following a route. New historical trips improve the arrival time prediction
performance (part 3.3).


\end{enumerate}




\chapter{Evaluation}

\section{Route Detection Evaluation}

\subsection{Sensitivity Score}

The first step is to check whether the 
$FollowsPath$(\textcolor{blue}{$sub$-$trip$}, \textcolor{red}{$path$})
predicate returns $true$ when the \textcolor{blue}{$sub$-$trip$} indeed
follows the \textcolor{red}{$path$}. I take the
\textcolor{red}{$path$} $992088$-$20150526$-$20150830$ to evaluate this step.
I have a set $T$ of 117 trips that went through it. For each trip
$t \in T$ I take a \textcolor{blue}{$sub$-$trip$} and check that the
$FollowsPath($\textcolor{blue}{$sub$-$trip$}, \textcolor{red}{$path$}$)$ 
predicate returns true: \\

\includegraphics[scale = 0.7]{figs/stop1.png} \\

For this route the $FollowsPath$ predicate has $100\%$ success rate.

\subsection{Specificity Score}

The second step is to check that for trips not on a path
the predicate returns false. \\

If a trip is very far away from the path (e.g. $10$ miles away), the
$FollowsPath(trip, path)$ will definitely return false. Thus, to perform
a meaningful evaluation, I select a \textcolor{blue}{path}
$1051719$-$20150531$-$20151224$ and a set of \textcolor{red}{trips}
$T$ following a very similar but nevertheless distinct path: \\

\includegraphics[scale = 0.6]{figs/similar_paths.png}

Both paths are the same at the beginning and separate later. For each
trip $\in T$ I pick a \textcolor{red}{$subtrip$} of the first 12
points\footnote{Each trip deviates from a path approximatelly after 12 GPS
points.} and check whether the
$FollowsPath(\textcolor{red}{subtrip}, \textcolor{blue}{path})$ 
returns false. Out of $107$ trips only once the predicate incorrectly returns
true. The misclassified \textcolor{red}{$subtrip$} has not deviated from a
\textcolor{blue}{path} yet for a predicate to detect that: \\

\includegraphics[scale = 0.6]{figs/misclassified_trip.png}

The sensitivity and specificity scores show that the $FollowsPath$
predicate works \textbf{if} used in the right place at the right time.

\newpage

\section{Arrival Time Prediction Evaluation}

\subsection{Evaluation Metrics Used}

This evaluation section is the most important. It shows how well the algorithm
predicts the arrival time. A few evaluation metrics are used repetitively
throughout the section. Hence, I want to present them. For the presentation I
will use the example route 1046531-20150531-20150830, which begins outside of
Cambridge and ends at the Cambridge Railway station: \\

\includegraphics[width=\textwidth]{figs/cambridge_route.png} \\

\begin{enumerate}
\item[(i)]
    \textbf{The MAE value}. Suppose I have a set
    of trips $T$, such that each trip eventually reaches a bus stop of interest. 
    Suppose for trip $t \in T$ the algorithm predicts the bus arrival time
    at stop to be $t_{predicted}$, but the bus actually arrives at $t_{actual}$.
    The absolute prediction error for trip $t$ is
    $E_t = |t_{actual} - t_{predicted}|$. The \textbf{mean} absolute prediction
    error for the whole set $T$ is

    \begin{center}
        $MAE = \frac{\sum\nolimits_{t \in {T}}{E_t}}{|T|}$
    \end{center}

    For example, suppose I predict when the buses will reach the Railway Station
    starting from the Central Cambridge stop. I have $558$ trips
    following this route to test my prediction. For each test trip, I assume
    only its history up to the Central Cambridge stop is known. I predict
    the arrival time to the Railway Station. After the prediction is made,
    I then read the rest of the history and check when the trip has actually
    arrived at the Railway Station. For this example trip, the resulting
    $MAE$ value is \textbf{98} sec. This number shows the average error the
    prediction algorithm makes. One can also use the MAE value to compare
    2 algorithms. I claim that the prediction algorithm $A$ performs better
    for some set than the algorithm $B$, if $MAE_A < MAE_B$.\footnote{Such claim will
    be seen later.}

\item[(ii)] \textbf{The scatter plot}. The $MAE$ value gives a first
   clue how well the algorithm performs. However, just the $MAE$ value
   alone is misleading. 98 seconds can be either a small or a large
   error. It depends how far in the future I am predicting. It takes about 10 
   minutes to reach the Railway Station from the Central Cambridge stop. Thus,
   98 seconds is an error \textbf{with respect to} the Central Cambridge stop. 
   The scatter plot formalises this relation:


\end{enumerate}

\includegraphics[width=\textwidth]{figs/scatter_plot.png} \\

\begin{itemize}

\item[]
   The x-axis labels the stop number $i$. For each $i$, I predict when the bus
   will reach the Railway Station (the last stop) starting from the $i$-th stop.
   The y-axis labels the absolute prediction error\footnote{Measured in seconds.}.
   A point $(i, y)$ tells that for some trip the prediction from the $i$-th stop
   to the last stop has an abolute error equal $y$. The more repeated errors
   $(i, y)$ I have, the larger point I plot. For completeness,
   in the diagram I show the MAE value\footnote{Labelled in yellow.} and the 
   average travel time\footnote{For each trip I calculate the time it actually
   takes to reach the last stop, then return the mean value.} from the $i$-th stop
   to the last stop.

   A few things can be observed in this plot:
   
\begin{itemize} 
   
   \item 
   Firstly, the $MAE$ value is smaller
   for each larger index $i$. The less time it takes for a bus to reach the last
   stop, the more accurate the prediction becomes.

   \item
   In my case, many prediction errors are smaller than the $MAE$ value,
   except for a few large errors that make the $MAE$ value increase. The large errors
   occur due to unusual traffic patterns:

   \includegraphics[scale=0.6]{figs/unusual_pattern.png} \\

    For some bus it took $4$ minutes to pass just a few buildings. Since most
    historical trips usually pass this segment in a much shorter
    time\footnote{e.g. 30s}, the predicted arrival time to the bus stop is
    much smaller than the actual arrival time. Therefore, the large error value 
    is generated.

    \item
    The scatter plot shows the absolute prediction errors only, not whether
    the bus arrived earlier or later than predicted. There is a simple reason for
    this: the prediction errors are symmetric, due to how my algorithm constructed
    is. On average, half of the errors are positive, half negative. Thus, it is
    enough to plot only the absolute errors and not lose any information.

\end{itemize}

All prediction points are shown on one plot. Hence, the scatter plot can be
used as a representative summary of what the algorithm predicts.


\end{itemize}

\begin{enumerate}

\item[(iii)] \textbf{The table of errors}. Traffic is different at a different time of
the day. I split the day into 4 disjoint time intervals:

\begin{enumerate}
\item[1.] $8$am--$10$am. The morning rush hour.
\item[2.] $10$am--$5$pm. The working hours.
\item[2.] $5$pm--$8$pm. The evening rush hour.
\item[3.] $8$pm--$8$am. I call all other hours as the 'night' time.



\end{enumerate}

I evaluate the prediction for each of the time intervals separately. The 
\textbf{table of errors} shows the aggregated results\footnote{As before,
I predict the arrival time to the \textbf{last} stop starting from each of the
other stops}:

\includegraphics[width=\textwidth]{figs/table_of_times.png}

The table of errors shows the different prediction errors for different
times of the day. It is useful for those who are interested in a
particular route and want to check the extent up to which the prediction system 
can be trusted for that route. For example, suppose I want to take a morning train
to London. I can look at the morning column of this table and see that on average
it takes $745$s. to reach the train station from the Central Cambridge. I can
also see that an algorithm on average predicts the arrival time to the train station
with an error of $99$s.

Note that the average travel time, as well as the mean absolute
prediction error values, are larger for the first and third intervals of time.
Hence, for this route the traffic is more congested and less predictable
during the rush hours.

\end{enumerate}


\subsection{Evaluation on more Routes}

The fact that an algorithm works on a single route does not neccessary imply that
it works on other routes. Hence, I evaluate the algorithm on $10$ other routes. The
detailed results are given in the appendix \ref{B1}. \\

The $10$ routes I have chosen are the popular ones. For each route I found
more than $100$ historical trips passing through all the route's stops. The tables of
errors given in the appendix \ref{B1} can serve as a reference point. Anyone writing a
new prediction algorithm can check whether it gives lower errors than those mentioned
in the appendix.

\subsection*{The Best Route}

\includegraphics[width=\textwidth]{figs/table_of_1056213.png}

Out of the $10$ routes, the algorithm performs best on the route
$1056213$-$20150614$-$20152323$:

\includegraphics[scale=0.65]{figs/best_route.png}

For many time intervals, the algorithm predicts the arrival time with an average error
less than $10\%$. \\

I believe, a long highway path is the reason, why an algorithm successful for this route is.
Firstly, highways have a feature that they they are less connected with other
roads\footnote{Compare a highway with a street in a city. The latter usually has many
intersections with other streets. The former has only a few connected roads to go in and out
of the highway.}. Other roads have a relatively little affect on the highway traffic.
Hence, only historical trips of the buses travelling along this route are enough to generate
reasonable predictions\footnote{And the implementation of my algorithm uses only historical trips
following this route.}. Secondly, the bus speed on the highway does not vary
much. For example, if for the last 5 minutes the bus speed was $60$mph., it is 
likely it will keep travelling at roughly the same speed\footnote{Contrast this with the
case when a bus is on the street in a city. The bus speed will fluctuate a lot due to
traffic lights, other cars causing a congestion, pedestratians crossing the street.}.
This second feature of a highway allows making a good use of the
Optimisation nr. 2. The optimisation predicts the arrival time using only those
historical trips that have travelled a certain distance using the same amount of
time\footnote{$\implies$ the same travel speed.} as the current trip. Since the travel
speed on a highway does not vary much, these historical trips will give an accurate
information how quickly a bus might reach the bus stop. \\

Finally, I include the scatter plot. As before, many prediction errors are below the $MAE$ value:

\includegraphics[scale=0.5]{figs/best_scatter_plot.png}

\subsection*{The Worst Route}

The algorithm performs poorly on the route $999024$-$20150526$-$20150830$: \\

\includegraphics[width=\textwidth]{figs/table_of_999024.png} \\

The poor performance is due to the following reasons. Firstly, there are many bus stops a bus
frequently\footnote{Every $2$min. or so.} stops at. The amount of time a bus is standing at one
stop affects its arrival time to the future stop, but the algorithm does not explicitly deal with
the bus standing time. \\

\includegraphics[scale=0.8]{figs/worst_route.png} \\

\newpage

Secondly, the route includes the crowded city places, such as the shopping centre: \\

\includegraphics[scale=0.6]{figs/shopping_centre.png} \\

The scatter plot shows the difficulty predicting the arrival time in the crowded areas:

\includegraphics[width=\textwidth]{figs/worst_scatter_plot.png}

One can see a big difference between the prediction results from the first stop (where the
crowded place located is) and from the other stops. The prediction errors predicting from
the first stop are not concentrated below the $MAE$ value. Instead, the errors are spread out
accross the whole range of $y$ values. After the bus leaves the crowded area, the prediction
errors become concentrated below the $MAE$ value, which is the usual characteristic of my
prediction algorithm. \\

I make the following conclusions:

\begin{itemize}

    \item My algorithm predicts the arrival time well for buses that are travelling from one city
    to another and are using highways for a long time.

    \item My algorithm may give a worse performance when predicting the arrival time in cities.


\end{itemize}



\newpage

\subsection{Different Systems Comparison}

\subsection*{Comparing Optimisations}

I first run the non-optimised algorithm to predict when the bus will reach the
Madingley Park starting from the Chesterton Road: \\

\includegraphics[width=\textwidth]{figs/madingley.png} \\

Training set having $30$ trips results in $MAE_0 = 105$s.\footnote{detailed
evaluation results are given in the appendix} \\

I now apply the optimisation nr. 1 on the same test set.\footnote{Recall that
the first optimisation predicts the arrival time from the recent trips only.
If there are no recent trips, the basic approach is used.} Looking at the
detailed results in the appendix, one can see that the
optimisation nr. 1 gives a big improvement for certain trips (e.g. the
prediction error drops from $380$s. to $40$s.) and leaves everything else
unchanged. Overall, this optimisation reduces the average prediction error to
$MAE_1 = 88$s. \\

Finally, I add the second optimisation to predict the arrival time.\footnote{The
second optimisation takes into account only equally congested historical trips.}
Both the 1st and 2nd optimisations together further reduce the average
prediction error to $MAE_{1,2} = 69$s. \\

Hence, I conclude that for this route the optimisations are worth to be applied.

\newpage

\subsection*{Comparison with the Timetable}

The prediction system is useful if for a particular route it is more accurate than
the timetable. A company named Traffi, which targets the same arrival time prediction
problem as me, agreed to share their traffic
data\footnote{I was given the November 2016 GPS data.}. \\

The Traffi data shows when the
bus has arrived at the stop \textbf{and also} when the bus was expected to arrive
according to the timetable. Hence, this data easily allows to compare my prediction
algorithm performance with the 'performance' of the timetable.\footnote{Assume the
arrival time prediction is what the timetable announces. Thus, one can view the
timetable as just an another prediction algorithm. Then the $MAE$ values for such an
algorithm are computed as usual. I compare the $MAE$ values of the 2 algorithms.}
Thus, I have chosen one of the routes from their dataset and evaluated my algorithm
on that route. \\

\includegraphics[width=\textwidth]{figs/vilnius_route.png} \\

The route is from my home city Vilnius. It has 18 bus stops and
I predict the arrival time to the last stop 'Pasaku Parkas' from each
of the other stops: \\


The evaluation results are shown on the next page. Two tables of errors are merged
into one and presented there. The left number of each coloured cell shows the
average prediction error of my algorithm. The right number of each coloured cell
shows the average prediction error of the timetable. \\


Note that for each column the right numbers are all the same. This is because the
arrival time announced by the timetable does not change while the bus is moving. \\

Only $4$ $MAE$ values out of $68$ are larger for my prediction algorithm. At the
beginning of the route, the bus is far away from the last stop, and I have a little amount
of recent information how it travels. That is the reason why the prediction errors
for the first stops might be worse than what the timetable announces. However,
starting from the later stops, the prediction algorithm outperforms the timetable.

\includegraphics[width=\textwidth]{figs/table_of_vilnius.png} \\




\newpage
\section{Real-time System Evaluation (Optional)}

Suppose for a particular bus the real time system detects the route $r$ it follows.
When the bus arrives at the $b$-th bus stop, the system predicts its arrival time 
$t_{predicted}$ to the last stop of that route. The current time $t_{current}$
and the predicted time are recorded. When the bus arrives at the last stop,
the system records its actual arrival time $t_{actual}$. Thus, the system saves
as many tuples

\begin{center}
$(r, b, t_{current}, t_{predicted}, t_{actual})$
\end{center}

as possible. When I have enough tuples for a particular route $r$, I can evaluate
how well my system performs for that route. \\

I present here the evaluation of the route 1051308-20150531-22000909. The route has 10
stops. I collected $38$ buses passing through this route in 3 days. I made the arrival
time prediction to the last stop. The results are as follows: \\

\includegraphics[scale=1.0]{figs/table_of_1051308.png}

\chapter{Conclusion}

I implemented an algorithm which gives sensible prediction results. The
algorithm itself is simple, thus anyone coming after me to improve the
system should not have a trouble to read and understand what has been done so far. \\

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% the appendices
\appendix

\chapter{Links}

\begin{enumerate}
\item Dynamic time warping is an algorithm for measuring similarity between
two temporal sequences which may vary in speed. For instance, similarities in
walking could be detected using DTW, even if one person was walking faster than
another. I used DTW algorithm as a core part to implement my $FollowsPath$
predicate, with $err$ function being used instead of a regular distance function 
$d(x, y)$.
For more info look at

\textcolor{blue}{\url{https://en.wikipedia.org/wiki/Dynamic_time_warping}}

\item Project code can be found at: 

\textcolor{blue}{\url{https://github.com/ml693/bus}}


\end{enumerate}

\chapter{Detailed Evaluation Results}

\section{Multiple Routes Evaluation}

\label{B1}

\includegraphics[width=\textwidth]{figs/table_of_1046521.png}
\includegraphics[width=\textwidth]{figs/table_of_999024.png}
\includegraphics[width=\textwidth]{figs/table_of_1028069.png}
\includegraphics[width=\textwidth]{figs/table_of_1053969.png}
\includegraphics[width=\textwidth]{figs/table_of_1030740.png}
\includegraphics[width=\textwidth]{figs/table_of_830638.png}
\includegraphics[width=\textwidth]{figs/table_of_1039292.png}
\includegraphics[width=\textwidth]{figs/table_of_1001579.png}
\includegraphics[width=\textwidth]{figs/table_of_1056213.png}
\includegraphics[width=\textwidth]{figs/table_of_1002879.png}

\newpage

\section{Predictions for Madingley Park}

Results without optimisations: \\

{\footnotesize
day18-bus14365-subtrip0 started at 2016-01-18 13:45:46, arrived at 2016-01-18 13:52:06, prediction error is -80 \\
day18-bus14368-subtrip2 started at 2016-01-18 21:14:38, arrived at 2016-01-18 21:21:18, prediction error is -60 \\
day18-bus14366-subtrip0 started at 2016-01-18 11:46:35, arrived at 2016-01-18 11:55:36, prediction error is 81 \\
day18-bus14369-subtrip1 started at 2016-01-18 17:46:33, arrived at 2016-01-18 17:55:13, prediction error is 59 \\
day18-bus403-subtrip0 started at 2016-01-18 11:23:07,    arrived at 2016-01-18 11:28:07, prediction error is -60 \\
day18-bus14374-subtrip0 started at 2016-01-18 16:15:35, arrived at 2016-01-18 16:22:35, prediction error is 19 \\
day18-bus14361-subtrip0 started at 2016-01-18 10:16:14, arrived at 2016-01-18 10:28:34, prediction error is 340 \\
day18-bus14370-subtrip0 started at 2016-01-18 10:30:47, arrived at 2016-01-18 10:44:47, prediction error is \textcolor{red}{\textbf{380}} \\ 
day18-bus14365-subtrip1 started at 2016-01-18 21:44:37, arrived at 2016-01-18 21:50:17, prediction error is -80 \\
day18-bus407-subtrip1 started at 2016-01-18 10:15:37,    arrived at 2016-01-18 10:28:40, prediction error is 334 \\
day18-bus14368-subtrip1 started at 2016-01-18 13:14:46, arrived at 2016-01-18 13:20:06, prediction error is -100 \\
day18-bus14363-subtrip1 started at 2016-01-18 15:46:05, arrived at 2016-01-18 15:53:45, prediction error is -20 \\
day18-bus14375-subtrip0 started at 2016-01-18 15:14:50, arrived at 2016-01-18 15:21:10, prediction error is -69 \\
day18-bus401-subtrip2 started at 2016-01-18 11:46:37,    arrived at 2016-01-18 11:55:38, prediction error is 81 \\
day18-bus14370-subtrip3 started at 2016-01-18 19:30:41, arrived at 2016-01-18 19:38:42, prediction error is 121 \\
day18-bus410-subtrip0 started at 2016-01-18 16:15:38,    arrived at 2016-01-18 16:22:38, prediction error is 20 \\
day18-bus402-subtrip0 started at 2016-01-18 10:30:38,    arrived at 2016-01-18 10:44:37, prediction error is \textcolor{red}{\textbf{379}} \\
day18-bus14373-subtrip0 started at 2016-01-18 16:46:02, arrived at 2016-01-18 16:53:42, prediction error is -1 \\
day18-bus14372-subtrip1 started at 2016-01-18 14:14:19, arrived at 2016-01-18 14:20:19, prediction error is -120 \\
day18-bus14367-subtrip2 started at 2016-01-19 00:35:49, arrived at 2016-01-19 00:40:49, prediction error is -160 \\
day18-bus14378-subtrip0 started at 2016-01-18 11:00:21, arrived at 2016-01-18 11:07:41, prediction error is 20 \\
day18-bus402-subtrip1 started at 2016-01-18 19:30:08,    arrived at 2016-01-18 19:38:37, prediction error is 89 \\
day18-bus400-subtrip0 started at 2016-01-18 10:59:38,    arrived at 2016-01-18 11:07:37, prediction error is 29 \\
day18-bus14087-subtrip0 started at 2016-01-18 09:30:34, arrived at 2016-01-18 09:36:34, prediction error is -120 \\
day18-bus409-subtrip0 started at 2016-01-18 08:25:38,    arrived at 2016-01-18 08:32:09, prediction error is -29 \\
day18-bus14371-subtrip1 started at 2016-01-18 08:54:47, arrived at 2016-01-18 09:01:07, prediction error is -70 \\
day18-bus14072-subtrip3 started at 2016-01-18 20:51:07, arrived at 2016-01-18 20:57:47, prediction error is -79 \\
day18-bus14072-subtrip1 started at 2016-01-18 12:45:18, arrived at 2016-01-18 12:53:18, prediction error is 20 \\
day18-bus14362-subtrip1 started at 2016-01-18 14:45:16, arrived at 2016-01-18 14:50:36, prediction error is -81 \\
day18-bus405-subtrip2 started at 2016-01-18 13:46:07,    arrived at 2016-01-18 13:52:08, prediction error is -59 \\
}

\newpage

Results with the optimisation nr. $1$: \\
{\footnotesize
day18-bus14365-subtrip0 started at 2016-01-18 13:45:46, arrived at 2016-01-18 13:52:06, prediction error is -80 \\
day18-bus14368-subtrip2 started at 2016-01-18 21:14:38, arrived at 2016-01-18 21:21:18, prediction error is 0 \\
day18-bus14366-subtrip0 started at 2016-01-18 11:46:35, arrived at 2016-01-18 11:55:36, prediction error is 81 \\
day18-bus14369-subtrip1 started at 2016-01-18 17:46:33, arrived at 2016-01-18 17:55:13, prediction error is 59 \\
day18-bus403-subtrip0 started at 2016-01-18 11:23:07,    arrived at 2016-01-18 11:28:07, prediction error is -60 \\
day18-bus14374-subtrip0 started at 2016-01-18 16:15:35,arrived at 2016-01-18 16:22:35, prediction error is 19 \\
day18-bus14361-subtrip0 started at 2016-01-18 10:16:14, arrived at 2016-01-18 10:28:34, prediction error is 340 \\
day18-bus14370-subtrip0 started at 2016-01-18 10:30:47, arrived at 2016-01-18 10:44:47, prediction error is \textcolor{green}{\textbf{40}} \\
day18-bus14365-subtrip1 started at 2016-01-18 21:44:37, arrived at 2016-01-18 21:50:17, prediction error is -60 \\
day18-bus407-subtrip1 started at 2016-01-18 10:15:37,    arrived at 2016-01-18 10:28:40, prediction error is 334 \\
day18-bus14368-subtrip1 started at 2016-01-18 13:14:46, arrived at 2016-01-18 13:20:06, prediction error is -100 \\
day18-bus14363-subtrip1 started at 2016-01-18 15:46:05, arrived at 2016-01-18 15:53:45, prediction error is -20 \\
day18-bus14375-subtrip0 started at 2016-01-18 15:14:50, arrived at 2016-01-18 15:21:10, prediction error is -69 \\
day18-bus401-subtrip2 started at 2016-01-18 11:46:37,    arrived at 2016-01-18 11:55:38, prediction error is 81 \\
day18-bus14370-subtrip3 started at 2016-01-18 19:30:41, arrived at 2016-01-18 19:38:42, prediction error is 121 \\
day18-bus410-subtrip0 started at 2016-01-18 16:15:38,    arrived at 2016-01-18 16:22:38, prediction error is 20 \\
day18-bus402-subtrip0 started at 2016-01-18 10:30:38,    arrived at 2016-01-18 10:44:37, prediction error is \textcolor{green}{\textbf{39}} \\
day18-bus14373-subtrip0 started at 2016-01-18 16:46:02, arrived at 2016-01-18 16:53:42, prediction error is -1 \\
day18-bus14372-subtrip1 started at 2016-01-18 14:14:19, arrived at 2016-01-18 14:20:19, prediction error is -31 \\
day18-bus14367-subtrip2 started at 2016-01-19 00:35:49, arrived at 2016-01-19 00:40:49, prediction error is -160 \\
day18-bus14378-subtrip0 started at 2016-01-18 11:00:21, arrived at 2016-01-18 11:07:41, prediction error is -200 \\
day18-bus402-subtrip1 started at 2016-01-18 19:30:08,    arrived at 2016-01-18 19:38:37, prediction error is 89 \\
day18-bus400-subtrip0 started at 2016-01-18 10:59:38,    arrived at 2016-01-18 11:07:37, prediction error is -241 \\
day18-bus14087-subtrip0 started at 2016-01-18 09:30:34, arrived at 2016-01-18 09:36:34, prediction error is -120 \\
day18-bus409-subtrip0 started at 2016-01-18 08:25:38,    arrived at 2016-01-18 08:32:09, prediction error is -29 \\
day18-bus14371-subtrip1 started at 2016-01-18 08:54:47, arrived at 2016-01-18 09:01:07, prediction error is -42 \\
day18-bus14072-subtrip3 started at 2016-01-18 20:51:07, arrived at 2016-01-18 20:57:47, prediction error is -79 \\
day18-bus14072-subtrip1 started at 2016-01-18 12:45:18, arrived at 2016-01-18 12:53:18, prediction error is 20 \\
day18-bus14362-subtrip1 started at 2016-01-18 14:45:16, arrived at 2016-01-18 14:50:36, prediction error is -81 \\
day18-bus405-subtrip2 started at 2016-01-18 13:46:07,    arrived at 2016-01-18 13:52:08, prediction error is 41 \\
}

Results with the optimisations nr. $1$ and nr. $2$: \\
{\footnotesize
day18-bus14365-subtrip0 started at 2016-01-18 13:45:46, arrived at 2016-01-18 13:52:06, prediction error is -100 \\
day18-bus14368-subtrip2 started at 2016-01-18 21:14:38, arrived at 2016-01-18 21:21:18, prediction error is -20 \\
day18-bus14366-subtrip0 started at 2016-01-18 11:46:35, arrived at 2016-01-18 11:55:36, prediction error is 41 \\
day18-bus14369-subtrip1 started at 2016-01-18 17:46:33, arrived at 2016-01-18 17:55:13, prediction error is 40 \\
day18-bus403-subtrip0 started at 2016-01-18 11:23:07,    arrived at 2016-01-18 11:28:07, prediction error is -59 \\
day18-bus14374-subtrip0 started at 2016-01-18 16:15:35, arrived at 2016-01-18 16:22:35, prediction error is 0 \\
day18-bus14361-subtrip0 started at 2016-01-18 10:16:14,arrived at 2016-01-18 10:28:34, prediction error is 280 \\
day18-bus14370-subtrip0 started at 2016-01-18 10:30:47, arrived at 2016-01-18 10:44:47, prediction error is 40 \\
day18-bus14365-subtrip1 started at 2016-01-18 21:44:37, arrived at 2016-01-18 21:50:17, prediction error is -51 \\
day18-bus407-subtrip1 started at 2016-01-18 10:15:37,    arrived at 2016-01-18 10:28:40, prediction error is 302 \\
day18-bus14368-subtrip1 started at 2016-01-18 13:14:46, arrived at 2016-01-18 13:20:06, prediction error is -100 \\
day18-bus14363-subtrip1 started at 2016-01-18 15:46:05, arrived at 2016-01-18 15:53:45, prediction error is -20 \\
day18-bus14375-subtrip0 started at 2016-01-18 15:14:50, arrived at 2016-01-18 15:21:10, prediction error is -42 \\
day18-bus401-subtrip2 started at 2016-01-18 11:46:37,    arrived at 2016-01-18 11:55:38, prediction error is 60 \\
day18-bus14370-subtrip3 started at 2016-01-18 19:30:41, arrived at 2016-01-18 19:38:42, prediction error is 122 \\
day18-bus410-subtrip0 started at 2016-01-18 16:15:38,    arrived at 2016-01-18 16:22:38, prediction error is 20 \\
day18-bus402-subtrip0 started at 2016-01-18 10:30:38,    arrived at 2016-01-18 10:44:37, prediction error is 39 \\
day18-bus14373-subtrip0 started at 2016-01-18 16:46:02, arrived at 2016-01-18 16:53:42, prediction error is -20 \\
day18-bus14372-subtrip1 started at 2016-01-18 14:14:19, arrived at 2016-01-18 14:20:19, prediction error is -31 \\
day18-bus14367-subtrip2 started at 2016-01-19 00:35:49, arrived at 2016-01-19 00:40:49, prediction error is -180 \\
day18-bus14378-subtrip0 started at 2016-01-18 11:00:21, arrived at 2016-01-18 11:07:41, prediction error is 20 \\
day18-bus402-subtrip1 started at 2016-01-18 19:30:08,    arrived at 2016-01-18 19:38:37, prediction error is 108 \\
day18-bus400-subtrip0 started at 2016-01-18 10:59:38,    arrived at 2016-01-18 11:07:37, prediction error is 29 \\
day18-bus14087-subtrip0 started at 2016-01-18 09:30:34, arrived at 2016-01-18 09:36:34, prediction error is -60 \\
day18-bus409-subtrip0 started at 2016-01-18 08:25:38,    arrived at 2016-01-18 08:32:09, prediction error is -9 \\
day18-bus14371-subtrip1 started at 2016-01-18 08:54:47, arrived at 2016-01-18 09:01:07, prediction error is -42 \\
day18-bus14072-subtrip3 started at 2016-01-18 20:51:07, arrived at 2016-01-18 20:57:47, prediction error is -81 \\
day18-bus14072-subtrip1 started at 2016-01-18 12:45:18, arrived at 2016-01-18 12:53:18, prediction error is -1 \\
day18-bus14362-subtrip1 started at 2016-01-18 14:45:16, arrived at 2016-01-18 14:50:36, prediction error is -80 \\
day18-bus405-subtrip2 started at 2016-01-18 13:46:07,    arrived at 2016-01-18 13:52:08, prediction error is -99 \\
}


\chapter{Project Proposal}
(see the next page)

\includepdf[pages=-]{proposal.pdf}

\end{document}
